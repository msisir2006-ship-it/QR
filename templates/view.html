<link rel="stylesheet" href="/static/style.css">

<div class="table-container">
    <h2>Attendance Records</h2>

    {% if cleared == '1' %}
        <div class="notice success">All attendance records were cleared successfully. {% if backup %}Backup saved: <a href="/static/backups/{{ backup }}" target="_blank">{{ backup }}</a>{% endif %}</div>
    {% elif cleared == '2' %}
        <div class="notice warn">No attendance records to clear.</div>
    {% endif %}

    {% if added == '1' %}
        <div class="notice success">✅ Attendance added successfully.</div>
    {% elif added == 'exists' %}
        <div class="notice warn">⚠️ Attendance already marked for this roll on that date.</div>
    {% elif added == 'error' %}
        <div class="notice warn">⚠️ Please provide both Roll and Name.</div>
    {% endif %}

    <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center;">
        <form method="get" action="/view" style="display:flex;gap:8px;align-items:center;">
            <select name="sub" id="subFilter" class="subject-select">
                <option value="">All Subjects</option>
                {% for s in subjects %}
                <option value="{{ s }}" {% if selected_subject==s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
            <select name="branch" class="subject-select">
                <option value="">All Branches</option>
                {% for b in branches %}
                <option value="{{ b }}" {% if selected_branch==b %}selected{% endif %}>{{ b }}</option>
                {% endfor %}
            </select>
            <input id="search" placeholder="Search by name..." style="padding:8px;border-radius:4px;border:1px solid #ccc;min-width:150px;">
            <button type="submit" class="action" style="padding:8px 12px;">Filter</button>
        </form>

        {% if selected_subject %}
        <a class="action" href="{{ url_for('export', sub=selected_subject) }}" style="padding:8px 12px;text-decoration:none;">Export CSV</a>
        {% else %}
        <a class="action" href="{{ url_for('export') }}" style="padding:8px 12px;text-decoration:none;">Export CSV</a>
        {% endif %}

        <form method="post" action="/clear_all" onsubmit="return confirm('This will delete attendance records for the selected filters permanently. Proceed?');" style="display:inline-block;margin-left:8px;">
            {% if selected_subject %}
            <input type="hidden" name="subject" value="{{ selected_subject }}">
            {% endif %}
            {% if selected_branch %}
            <input type="hidden" name="branch" value="{{ selected_branch }}">
            {% endif %}
            <button type="submit" class="clear-btn">Clear All</button>
        </form>
    </div>

    <div class="table-wrapper">
    <table class="attendance-table" width="100%">
        <thead>
        <tr>
            <th>Roll</th>
            <th>Name</th>
            <th>Subject</th>
            <th>Branch</th>
            <th>Date</th>
            <th>Time</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody>
        {% for row in data %}
        <tr>
            <td>{{ row[0] }}</td>
            <td>{{ row[1] }}</td>
            <td>{{ row[4] if row|length > 4 else '' }}</td>
            <td>{{ row[5] if row|length > 5 else '' }}</td>
            <td>{{ row[2] }}</td>
            <td>{{ row[3] }}</td>
            {% if row|length > 4 and row[4] %}
            <td><a href="{{ url_for('delete', roll=row[0], date=row[2], time=row[3], subject=row[4]) }}" onclick="return confirm('Delete attendance for {{ row[0] }} on {{ row[2] }} at {{ row[3] }} ({{ row[4] }})?');" class="delete-btn">Delete</a></td>
            {% else %}
            <td><a href="{{ url_for('delete', roll=row[0], date=row[2], time=row[3]) }}" onclick="return confirm('Delete attendance for {{ row[0] }} on {{ row[2] }} at {{ row[3] }}?');" class="delete-btn">Delete</a></td>
            {% endif %}
        </tr>
        {% else %}
        <tr>
            <td colspan="6">No attendance records found.</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    </div>
</div>

<script>
document.getElementById('search').addEventListener('input', function(e){
    const q=e.target.value.toLowerCase();
    document.querySelectorAll('.attendance-table tbody tr').forEach(function(row){
        const text = row.textContent.toLowerCase();
        row.style.display = text.indexOf(q) > -1 ? '' : 'none';
    });
});

// Manual add form toggle and defaults - removed as feature moved to admin dashboard
</script>